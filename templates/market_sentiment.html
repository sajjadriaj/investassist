{% extends 'base.html' %}

{% block content %}
<div class="space-y-6">
    <!-- Key Metrics -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
        <div class="bg-white rounded-lg shadow-lg border border-gray-200 overflow-hidden hover:shadow-xl transition-shadow duration-300">
            <div class="bg-gradient-to-r from-blue-500 to-blue-600 px-4 py-3">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-2">
                        <i class="fas fa-dollar-sign text-white text-lg"></i>
                        <h4 class="font-semibold text-white text-sm">Current Price</h4>
                    </div>
                    <div class="flex items-center space-x-1">
                        <span class="inline-flex items-center px-1.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">
                            <i class="fas fa-clock mr-1"></i>Delayed
                        </span>
                    </div>
                </div>
            </div>
            <div class="p-4 text-center">
                <p class="text-3xl font-bold text-gray-900 mb-1" data-price-display>${{ data.current_price | round(2) if data.current_price else 'N/A' }}</p>
                <p class="text-xs text-gray-500">Latest closing price (~15-20 min delay)</p>
            </div>
        </div>
        
        <div class="bg-white rounded-lg shadow-lg border border-gray-200 overflow-hidden hover:shadow-xl transition-shadow duration-300">
            <div class="bg-gradient-to-r from-green-500 to-green-600 px-4 py-3">
                <div class="flex items-center space-x-2">
                    <i class="fas fa-building text-white text-lg"></i>
                    <h4 class="font-semibold text-white text-sm">Market Cap</h4>
                </div>
            </div>
            <div class="p-4 text-center">
                <p class="text-3xl font-bold text-gray-900 mb-1">
                    {% if data.market_cap %}
                        {{ (data.market_cap / 1000000000) | round(2) }}B
                    {% else %}
                        N/A
                    {% endif %}
                </p>
                <p class="text-xs text-gray-500">Total market value</p>
            </div>
        </div>
        
        <div class="bg-white rounded-lg shadow-lg border border-gray-200 overflow-hidden hover:shadow-xl transition-shadow duration-300">
            <div class="bg-gradient-to-r from-purple-500 to-purple-600 px-4 py-3">
                <div class="flex items-center space-x-2">
                    <i class="fas fa-chart-pie text-white text-lg"></i>
                    <h4 class="font-semibold text-white text-sm">P/E Ratio</h4>
                </div>
            </div>
            <div class="p-4 text-center">
                <p class="text-3xl font-bold text-gray-900 mb-1">
                    {% if data.pe_ratio %}
                        {{ data.pe_ratio | round(2) }}
                    {% else %}
                        N/A
                    {% endif %}
                </p>
                <p class="text-xs text-gray-500">Price-to-earnings</p>
            </div>
        </div>
        
        <div class="bg-white rounded-lg shadow-lg border border-gray-200 overflow-hidden hover:shadow-xl transition-shadow duration-300">
            <div class="bg-gradient-to-r from-orange-500 to-orange-600 px-4 py-3">
                <div class="flex items-center space-x-2">
                    <i class="fas fa-percentage text-white text-lg"></i>
                    <h4 class="font-semibold text-white text-sm">Dividend Yield</h4>
                </div>
            </div>
            <div class="p-4 text-center">
                <p class="text-3xl font-bold text-gray-900 mb-1">
                    {% if data.dividend_yield %}
                        {{ (data.dividend_yield * 100) | round(2) }}%
                    {% else %}
                        N/A
                    {% endif %}
                </p>
                <p class="text-xs text-gray-500">Annual dividend</p>
            </div>
        </div>
    </div>

    <!-- Technical Summary -->
    <div class="bg-white p-6 rounded-lg shadow-md border">
        <h3 class="text-xl font-bold text-gray-900 mb-4">Technical Summary</h3>
        {% if data.technical_summary and data.technical_summary|length > 0 %}
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            {% for point in data.technical_summary %}
            <div class="bg-gray-50 p-4 rounded-lg border">
                <h4 class="font-bold text-gray-800">{{ point.indicator }} - <span class="
                    {% if point.signal == 'Bullish' %} text-green-500
                    {% elif point.signal == 'Bearish' %} text-red-500
                    {% else %} text-gray-500
                    {% endif %}
                ">{{ point.signal }}</span></h4>
                <p class="text-gray-600 mt-2 text-sm">{{ point.description }}</p>
                <p class="text-xs text-gray-500 mt-2">{{ point.info }}</p>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="bg-gray-50 rounded-lg p-8 text-center border border-gray-200">
            <i class="fas fa-chart-line text-gray-400 text-4xl mb-4"></i>
            <h4 class="text-lg font-semibold text-gray-700 mb-2">No Technical Data Available</h4>
            <p class="text-gray-500">Technical analysis data is not available for this ticker. Try selecting a different stock symbol.</p>
        </div>
        {% endif %}
    </div>

    <!-- Fundamental Analysis -->
    <div class="bg-white rounded-lg shadow-lg border border-gray-200">
        <div class="bg-gradient-to-r from-blue-50 to-indigo-50 px-6 py-4 border-b border-gray-200">
            <div class="flex items-center space-x-3">
                <div class="bg-blue-500 p-2 rounded-lg">
                    <i class="fas fa-chart-line text-white text-lg"></i>
                </div>
                <div>
                    <h3 class="text-xl font-bold text-gray-900">Fundamental Analysis</h3>
                    <p class="text-sm text-gray-600">Key financial metrics and performance indicators</p>
                </div>
            </div>
        </div>
        
        <div class="p-6">
            {% if data.fundamental_analysis.key_financials and data.fundamental_analysis.key_financials|length > 0 %}
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                {% for item in data.fundamental_analysis.key_financials %}
                <div class="bg-gray-50 rounded-lg p-4 border border-gray-100 hover:shadow-md transition-shadow duration-200">
                    <div class="flex items-center justify-between mb-2">
                        <h5 class="font-semibold text-gray-800 text-sm">{{ item.label }}</h5>
                        <div class="text-xs text-gray-500 cursor-help" title="{{ item.info }}">
                            <i class="fas fa-info-circle"></i>
                        </div>
                    </div>
                    <div class="text-2xl font-bold text-gray-900 mb-1">{{ item.value }}</div>
                    <p class="text-xs text-gray-500 leading-tight">{{ item.info }}</p>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="bg-gray-50 rounded-lg p-8 text-center border border-gray-200 mb-6">
                <i class="fas fa-calculator text-gray-400 text-4xl mb-4"></i>
                <h4 class="text-lg font-semibold text-gray-700 mb-2">No Fundamental Data Available</h4>
                <p class="text-gray-500">Fundamental analysis data is not available for this ticker. Try selecting a different stock symbol.</p>
            </div>
            {% endif %}
            
            <!-- Financial Health Summary -->
            <div class="bg-gradient-to-r from-gray-50 to-blue-50 rounded-lg p-4 border border-gray-200">
                <div class="flex items-center space-x-2 mb-2">
                    <i class="fas fa-heartbeat text-blue-500"></i>
                    <h4 class="font-semibold text-gray-800">Financial Health Overview</h4>
                </div>
                <p class="text-sm text-gray-600">
                    Analysis based on key financial ratios including profitability, liquidity, and growth metrics. 
                    These indicators help assess the company's financial stability and growth potential.
                </p>
                <div class="mt-3 flex flex-wrap gap-2">
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                        <i class="fas fa-chart-bar mr-1"></i> Performance Metrics
                    </span>
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                        <i class="fas fa-trending-up mr-1"></i> Growth Indicators
                    </span>
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-purple-100 text-purple-800">
                        <i class="fas fa-balance-scale mr-1"></i> Financial Ratios
                    </span>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts -->
    <div class="space-y-6">
        <!-- Chart Time Period Filter -->
        <div class="bg-white p-4 rounded-lg shadow-md border">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold text-gray-900">Chart Time Period</h3>
                <div class="flex space-x-2">
                    <button class="time-filter-btn px-3 py-1 text-sm rounded-md bg-blue-500 text-white" data-period="1d">1D</button>
                    <button class="time-filter-btn px-3 py-1 text-sm rounded-md bg-gray-200 text-gray-700 hover:bg-gray-300" data-period="5d">5D</button>
                    <button class="time-filter-btn px-3 py-1 text-sm rounded-md bg-gray-200 text-gray-700 hover:bg-gray-300" data-period="30d">30D</button>
                    <button class="time-filter-btn px-3 py-1 text-sm rounded-md bg-gray-200 text-gray-700 hover:bg-gray-300" data-period="6m">6M</button>
                    <button class="time-filter-btn px-3 py-1 text-sm rounded-md bg-gray-200 text-gray-700 hover:bg-gray-300" data-period="1y">1Y</button>
                </div>
            </div>
        </div>
        
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <div class="bg-white p-6 rounded-lg shadow-md border">
            <div class="flex justify-between items-center mb-2">
                <h3 class="text-xl font-bold text-gray-900">Price Chart</h3>
                <button class="text-gray-500 hover:text-blue-600" onclick="openChartModal(window.priceChartData, 'line')"><i class="fas fa-expand"></i></button>
            </div>
            <p class="text-sm text-gray-500 mb-4">Price movements showing Close, High, Low prices with support and resistance levels.</p>
            <div style="height: 400px;">
                <canvas id="price-chart"></canvas>
            </div>
        </div>
        <div class="bg-white p-6 rounded-lg shadow-md border">
            <div class="flex justify-between items-center mb-2">
                <h3 class="text-xl font-bold text-gray-900">Moving Averages (SMA)</h3>
                <button class="text-gray-500 hover:text-blue-600" onclick="openChartModal(window.smaChartData, 'line')"><i class="fas fa-expand"></i></button>
            </div>
            <p class="text-sm text-gray-500 mb-4">Simple Moving Averages (20-day and 50-day) to identify trends.</p>
            <div style="height: 400px;">
                <canvas id="sma-chart"></canvas>
            </div>
        </div>
        <div class="bg-white p-6 rounded-lg shadow-md border">
            <div class="flex justify-between items-center mb-2">
                <h3 class="text-xl font-bold text-gray-900">MACD</h3>
                <button class="text-gray-500 hover:text-blue-600" onclick="openChartModal(window.macdChartData, 'bar')"><i class="fas fa-expand"></i></button>
            </div>
            <p class="text-sm text-gray-500 mb-4">Moving Average Convergence Divergence, a momentum indicator.</p>
            <div style="height: 400px;">
                <canvas id="macd-chart"></canvas>
            </div>
        </div>
        <div class="bg-white p-6 rounded-lg shadow-md border">
            <div class="flex justify-between items-center mb-2">
                <h3 class="text-xl font-bold text-gray-900">RSI</h3>
                <button class="text-gray-500 hover:text-blue-600" onclick="openChartModal(window.rsiChartData, 'line')"><i class="fas fa-expand"></i></button>
            </div>
            <p class="text-sm text-gray-500 mb-4">Relative Strength Index, indicating overbought or oversold conditions.</p>
            <div style="height: 400px;">
                <canvas id="rsi-chart"></canvas>
            </div>
        </div>
        <div class="bg-white p-6 rounded-lg shadow-md border">
            <div class="flex justify-between items-center mb-2">
                <h3 class="text-xl font-bold text-gray-900">Bollinger Bands</h3>
                <button class="text-gray-500 hover:text-blue-600" onclick="openChartModal(window.bbandsChartData, 'line')"><i class="fas fa-expand"></i></button>
            </div>
            <p class="text-sm text-gray-500 mb-4">Volatility bands around a simple moving average.</p>
            <div style="height: 400px;">
                <canvas id="bbands-chart"></canvas>
            </div>
        </div>
        <div class="bg-white p-6 rounded-lg shadow-md border">
            <div class="flex justify-between items-center mb-2">
                <h3 class="text-xl font-bold text-gray-900">On-Balance Volume (OBV)</h3>
                <button class="text-gray-500 hover:text-blue-600" onclick="openChartModal(window.obvChartData, 'line')"><i class="fas fa-expand"></i></button>
            </div>
            <p class="text-sm text-gray-500 mb-4">Measures buying and selling pressure as a cumulative total volume.</p>
            <div style="height: 400px;">
                <canvas id="obv-chart"></canvas>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Global variables for chart data and filter state
let originalPriceData = [];
let originalTechData = [];
let currentPeriod = '1d';
let allCharts = {};
const currentTicker = '{{ selected_ticker }}';

document.addEventListener('DOMContentLoaded', function() {
    originalPriceData = {{ data.price_history | tojson }} || [];
    originalTechData = {{ data.technical_indicators | tojson }} || [];

    console.log("Price Data:", originalPriceData);
    console.log("Technical Data:", originalTechData);

    if (originalPriceData.length === 0) {
        console.log("No price data available - showing placeholder charts");
        showPlaceholderCharts();
        return;
    }

    // Initialize charts with default 1D filter
    filterAndUpdateCharts(currentPeriod);
    
    // Add event listeners for time period buttons
    document.querySelectorAll('.time-filter-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            // Update active button
            document.querySelectorAll('.time-filter-btn').forEach(b => {
                b.className = 'time-filter-btn px-3 py-1 text-sm rounded-md bg-gray-200 text-gray-700 hover:bg-gray-300';
            });
            this.className = 'time-filter-btn px-3 py-1 text-sm rounded-md bg-blue-500 text-white';
            
            // Update charts with new period
            currentPeriod = this.dataset.period;
            filterAndUpdateCharts(currentPeriod);
        });
    });
});

function filterAndUpdateCharts(period) {
    console.log(`Filtering charts for period: ${period}`);
    
    // Show loading state
    showLoadingState();
    
    // Fetch fresh data for the selected period from server
    fetch(`/api/market_sentiment/${currentTicker}/${period}`)
        .then(response => {
            console.log('API response received:', response.status);
            return response.json();
        })
        .then(data => {
            console.log('API data:', data);
            if (data.success) {
                console.log(`Fetched ${data.data.data_points} data points for ${period} period using ${data.data.interval_used} interval`);
                
                // Update the charts with fresh data
                updateAllCharts(data.data.price_history, data.data.technical_indicators);
                
                // Update current price if provided
                if (data.data.current_price) {
                    updateCurrentPrice(data.data.current_price);
                }
                
                console.log('Charts updated successfully');
            } else {
                console.error('Error fetching period data:', data.error);
                showErrorState(data.error);
            }
        })
        .catch(error => {
            console.error('Error fetching period data:', error);
            showErrorState('Failed to fetch data for selected time period');
        });
}

function filterDataByPeriod(priceData, techData, period) {
    if (!priceData || priceData.length === 0) {
        return { filteredPriceData: [], filteredTechData: [] };
    }
    
    const now = new Date();
    let cutoffDate;
    
    switch(period) {
        case '1d':
            cutoffDate = new Date(now.getTime() - (1 * 24 * 60 * 60 * 1000));
            break;
        case '5d':
            cutoffDate = new Date(now.getTime() - (5 * 24 * 60 * 60 * 1000));
            break;
        case '30d':
            cutoffDate = new Date(now.getTime() - (30 * 24 * 60 * 60 * 1000));
            break;
        case '6m':
            cutoffDate = new Date(now.getTime() - (6 * 30 * 24 * 60 * 60 * 1000));
            break;
        case '1y':
        default:
            cutoffDate = new Date(now.getTime() - (365 * 24 * 60 * 60 * 1000));
            break;
    }
    
    const filteredPriceData = priceData.filter(item => {
        const itemDate = new Date(item.Date);
        return itemDate >= cutoffDate;
    });
    
    const filteredTechData = techData.filter(item => {
        const itemDate = new Date(item.Date || item.date);
        return itemDate >= cutoffDate;
    });
    
    return { filteredPriceData, filteredTechData };
}

function showPlaceholderCharts() {
    const chartContainers = document.querySelectorAll('canvas');
    chartContainers.forEach(canvas => {
        const container = canvas.parentElement;
        container.innerHTML = `
            <div class="flex items-center justify-center h-full bg-gray-50 rounded-lg border border-gray-200">
                <div class="text-center">
                    <i class="fas fa-chart-area text-gray-400 text-4xl mb-4"></i>
                    <h4 class="text-lg font-semibold text-gray-700 mb-2">No Chart Data Available</h4>
                    <p class="text-gray-500">Chart data is not available for this time period.</p>
                </div>
            </div>
        `;
    });
}

function updateAllCharts(priceData, techData) {
    // Hide loading state first
    hideLoadingState();
    
    // Destroy existing charts
    Object.values(allCharts).forEach(chart => {
        if (chart) chart.destroy();
    });
    allCharts = {};
    
    const labels = priceData.map(d => d.Date);

    // Chart Options (common for all charts)
    const commonChartOptions = {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
            x: {
                type: 'time',
                time: {
                    unit: getDynamicTimeUnit(currentPeriod)
                },
                grid: { display: false }
            },
            y: {
                beginAtZero: false,
                grid: { display: false }
            }
        },
        plugins: {
            legend: { display: true },
            tooltip: {
                mode: 'index',
                intersect: false,
            }
        }
    };

    // Create charts (canvas elements should already exist)
    
    // Price Chart
    window.priceChartData = {
        labels: labels,
        datasets: [
            {
                label: 'Close Price',
                data: priceData.map(d => d.Close),
                borderColor: '#3b82f6',
                backgroundColor: 'rgba(59, 130, 246, 0.1)',
                fill: true,
                pointRadius: currentPeriod === '1d' ? 2 : 1,
                pointHoverRadius: 4,
                tension: 0.1
            },
            {
                label: 'High',
                data: priceData.map(d => d.High),
                borderColor: '#10b981',
                backgroundColor: 'transparent',
                fill: false,
                pointRadius: 0,
                borderWidth: 1,
                borderDash: [2, 2]
            },
            {
                label: 'Low',
                data: priceData.map(d => d.Low),
                borderColor: '#ef4444',
                backgroundColor: 'transparent',
                fill: false,
                pointRadius: 0,
                borderWidth: 1,
                borderDash: [2, 2]
            },
            {
                label: 'Support',
                data: techData.map(d => d.Support),
                borderColor: '#f59e0b',
                backgroundColor: 'transparent',
                fill: false,
                pointRadius: 0,
                borderWidth: 2,
                borderDash: [5, 5]
            },
            {
                label: 'Resistance',
                data: techData.map(d => d.Resistance),
                borderColor: '#8b5cf6',
                backgroundColor: 'transparent',
                fill: false,
                pointRadius: 0,
                borderWidth: 2,
                borderDash: [5, 5]
            }
        ]
    };
    
    const priceCtx = document.getElementById('price-chart');
    if (priceCtx) {
        allCharts.priceChart = new Chart(priceCtx, {
            type: 'line',
            data: window.priceChartData,
            options: {
                ...commonChartOptions,
                plugins: {
                    ...commonChartOptions.plugins,
                    tooltip: {
                        mode: 'index',
                        intersect: false,
                        callbacks: {
                            title: function(context) {
                                return new Date(context[0].parsed.x).toLocaleDateString();
                            },
                            label: function(context) {
                                return context.dataset.label + ': $' + context.parsed.y.toFixed(2);
                            }
                        }
                    }
                }
            }
        });
    }

    // Create other charts (SMA, MACD, RSI, Bollinger Bands, OBV)
    createTechnicalCharts(labels, techData, priceData, commonChartOptions);
}

function getDynamicTimeUnit(period) {
    switch(period) {
        case '1d': return 'hour';
        case '5d': return 'day';
        case '30d': return 'day';
        case '6m': return 'week';
        case '1y': return 'month';
        default: return 'day';
    }
}

function recreateCanvasElements() {
    const canvasIds = ['price-chart', 'sma-chart', 'macd-chart', 'rsi-chart', 'bbands-chart', 'obv-chart'];
    canvasIds.forEach(id => {
        const canvas = document.getElementById(id);
        if (canvas) {
            const parent = canvas.parentElement;
            const newCanvas = document.createElement('canvas');
            newCanvas.id = id;
            parent.replaceChild(newCanvas, canvas);
        }
    });
}

function createTechnicalCharts(labels, techData, priceData, commonChartOptions) {
    // SMA Chart
    window.smaChartData = {
        labels: labels,
        datasets: [
            {
                label: 'SMA20',
                data: techData.map(d => d.SMA20),
                borderColor: '#f59e0b',
                fill: false,
                pointRadius: 0,
            },
            {
                label: 'SMA50',
                data: techData.map(d => d.SMA50),
                borderColor: '#10b981',
                fill: false,
                pointRadius: 0,
            }
        ]
    };
    const smaCtx = document.getElementById('sma-chart');
    if (smaCtx) {
        allCharts.smaChart = new Chart(smaCtx, {
            type: 'line',
            data: window.smaChartData,
            options: commonChartOptions
        });
    }

    // MACD Chart
    window.macdChartData = {
        labels: labels,
        datasets: [
            {
                label: 'MACD Hist',
                data: techData.map(d => d.MACD_hist),
                backgroundColor: function(context) {
                    const value = context.raw;
                    return value > 0 ? 'rgba(16, 185, 129, 0.5)' : 'rgba(239, 68, 68, 0.5)';
                },
                yAxisID: 'macd-hist',
            },
            {
                label: 'MACD',
                data: techData.map(d => d.MACD),
                type: 'line',
                borderColor: '#f59e0b',
                fill: false,
                pointRadius: 0,
                yAxisID: 'macd-line',
            },
            {
                label: 'MACD Signal',
                data: techData.map(d => d.MACD_signal),
                type: 'line',
                borderColor: '#ef4444',
                fill: false,
                pointRadius: 0,
                yAxisID: 'macd-line',
            }
        ]
    };
    const macdCtx = document.getElementById('macd-chart');
    if (macdCtx) {
        allCharts.macdChart = new Chart(macdCtx, {
            type: 'bar',
            data: window.macdChartData,
            options: {
                ...commonChartOptions,
                scales: {
                    x: commonChartOptions.scales.x,
                    'macd-hist': {
                        type: 'linear',
                        position: 'left',
                        grid: { display: false }
                    },
                    'macd-line': {
                        type: 'linear',
                        position: 'left',
                        grid: { display: false }
                    }
                }
            }
        });
    }

    // RSI Chart
    window.rsiChartData = {
        labels: labels,
        datasets: [{
            label: 'RSI',
            data: techData.map(d => d.RSI),
            borderColor: '#8b5cf6',
            backgroundColor: 'rgba(139, 92, 246, 0.1)',
            fill: true,
            pointRadius: 0,
        }]
    };
    const rsiCtx = document.getElementById('rsi-chart');
    if (rsiCtx) {
        allCharts.rsiChart = new Chart(rsiCtx, {
            type: 'line',
            data: window.rsiChartData,
            options: {
                ...commonChartOptions,
                scales: {
                    x: commonChartOptions.scales.x,
                    y: {
                        ...commonChartOptions.scales.y,
                        min: 0,
                        max: 100,
                    }
                }
            }
        });
    }

    // Bollinger Bands Chart
    window.bbandsChartData = {
        labels: labels,
        datasets: [
            {
                label: 'Close Price',
                data: priceData.map(d => d.Close),
                borderColor: '#3b82f6',
                fill: false,
                pointRadius: 0,
            },
            {
                label: 'BB Upper',
                data: techData.map(d => d.BB_upper),
                borderColor: '#ef4444',
                fill: '+1',
                backgroundColor: 'rgba(239, 68, 68, 0.1)',
                pointRadius: 0,
            },
            {
                label: 'BB Middle',
                data: techData.map(d => d.BB_middle),
                borderColor: '#f59e0b',
                fill: false,
                pointRadius: 0,
            },
            {
                label: 'BB Lower',
                data: techData.map(d => d.BB_lower),
                borderColor: '#ef4444',
                fill: '-1',
                backgroundColor: 'rgba(239, 68, 68, 0.1)',
                pointRadius: 0,
            }
        ]
    };
    const bbandsCtx = document.getElementById('bbands-chart');
    if (bbandsCtx) {
        allCharts.bbandsChart = new Chart(bbandsCtx, {
            type: 'line',
            data: window.bbandsChartData,
            options: commonChartOptions
        });
    }

    // OBV Chart
    window.obvChartData = {
        labels: labels,
        datasets: [{
            label: 'On-Balance Volume',
            data: techData.map(d => d.OBV),
            borderColor: '#14b8a6',
            backgroundColor: 'rgba(20, 184, 166, 0.1)',
            fill: true,
            pointRadius: 0,
        }]
    };
    const obvCtx = document.getElementById('obv-chart');
    if (obvCtx) {
        allCharts.obvChart = new Chart(obvCtx, {
            type: 'line',
            data: window.obvChartData,
            options: commonChartOptions
        });
    }
}

// Chart Modal Functionality (updated to work with filtered data)
function openChartModal(chartData, chartType) {
    // Create modal if it doesn't exist
    let modal = document.getElementById('chart-modal');
    if (!modal) {
        modal = document.createElement('div');
        modal.id = 'chart-modal';
        modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden';
        modal.innerHTML = `
            <div class="bg-white p-6 rounded-lg shadow-xl max-w-6xl w-full mx-4 max-h-[90vh] overflow-auto">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold text-gray-900">Chart Details - ${currentPeriod.toUpperCase()}</h3>
                    <button onclick="closeChartModal()" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>
                <div style="height: 600px;">
                    <canvas id="modal-chart"></canvas>
                </div>
            </div>
        `;
        document.body.appendChild(modal);
    }

    // Show modal
    modal.classList.remove('hidden');

    // Destroy existing chart if any
    if (window.modalChart) {
        window.modalChart.destroy();
    }

    // Create new chart in modal
    const modalCtx = document.getElementById('modal-chart').getContext('2d');
    window.modalChart = new Chart(modalCtx, {
        type: chartType,
        data: chartData,
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                x: {
                    type: 'time',
                    time: {
                        unit: getDynamicTimeUnit(currentPeriod)
                    },
                    grid: { display: false }
                },
                y: {
                    beginAtZero: false,
                    grid: { display: true, color: 'rgba(0,0,0,0.1)' }
                }
            },
            plugins: {
                legend: { 
                    display: true,
                    position: 'top'
                },
                tooltip: {
                    mode: 'index',
                    intersect: false,
                }
            }
        }
    });
}

function closeChartModal() {
    const modal = document.getElementById('chart-modal');
    if (modal) {
        modal.classList.add('hidden');
    }
    if (window.modalChart) {
        window.modalChart.destroy();
        window.modalChart = null;
    }
}

// Close modal when clicking outside
document.addEventListener('click', function(event) {
    const modal = document.getElementById('chart-modal');
    if (modal && event.target === modal) {
        closeChartModal();
    }
});

// Time period filtering functionality
function loadPeriodData(period) {
    console.log('Loading data for period:', period);
    
    // Update active button
    document.querySelectorAll('.period-btn').forEach(btn => {
        btn.classList.remove('bg-blue-500', 'text-white');
        btn.classList.add('bg-gray-200', 'text-gray-700');
    });
    
    const activeBtn = document.querySelector(`[onclick="loadPeriodData('${period}')"]`);
    if (activeBtn) {
        activeBtn.classList.remove('bg-gray-200', 'text-gray-700');
        activeBtn.classList.add('bg-blue-500', 'text-white');
    }
    
    // Show loading indicator
    showLoadingIndicator();
    
    // Update current period
    window.currentPeriod = period;
    
    // Fetch data for the period
    const ticker = '{{ selected_ticker }}';
    fetch(`/api/market_sentiment/${ticker}/${period}`)
        .then(response => response.json())
        .then(data => {
            hideLoadingIndicator();
            if (data.success) {
                updateChartsWithPeriodData(data.data, period);
            } else {
                console.error('Error loading period data:', data.error);
                showErrorMessage(`Error loading ${period} data: ${data.error}`);
            }
        })
        .catch(error => {
            hideLoadingIndicator();
            console.error('Error:', error);
            showErrorMessage(`Failed to load ${period} data`);
        });
}

function showLoadingIndicator() {
    const chartContainers = document.querySelectorAll('canvas');
    chartContainers.forEach(canvas => {
        const container = canvas.parentElement;
        container.innerHTML = `
            <div class="flex items-center justify-center h-full">
                <div class="text-center">
                    <i class="fas fa-spinner fa-spin text-blue-500 text-4xl mb-4"></i>
                    <p class="text-gray-500">Loading chart data...</p>
                </div>
            </div>
        `;
    });
}

function hideLoadingIndicator() {
    // Charts will be recreated, so this will be handled by updateChartsWithPeriodData
}

function showErrorMessage(message) {
    const chartContainers = document.querySelectorAll('canvas');
    chartContainers.forEach(canvas => {
        const container = canvas.parentElement;
        container.innerHTML = `
            <div class="flex items-center justify-center h-full bg-red-50 rounded-lg border border-red-200">
                <div class="text-center">
                    <i class="fas fa-exclamation-triangle text-red-500 text-4xl mb-4"></i>
                    <h4 class="text-lg font-semibold text-red-700 mb-2">Error</h4>
                    <p class="text-red-600">${message}</p>
                </div>
            </div>
        `;
    });
}

function updateChartsWithPeriodData(data, period) {
    console.log(`Updating charts with ${period} data:`, data);
    if (data.data_points) {
        console.log(`Data points: ${data.data_points}, Interval: ${data.interval_used}`);
    }
    
    const priceData = data.price_history || [];
    const techData = data.technical_indicators || [];
    
    if (priceData.length === 0) {
        console.log("No price data available for period", period);
        showNoDataMessage();
        return;
    }
    
    // Parse dates properly (handle both daily and intraday formats)
    const labels = priceData.map(d => {
        const dateStr = d.Date;
        // Check if it includes time (intraday data)
        if (dateStr.includes(' ')) {
            return new Date(dateStr.replace(' ', 'T'));
        } else {
            return new Date(dateStr);
        }
    });
    
    // Update chart options for different periods
    const timeUnit = period === '1d' ? 'hour' : 
                   period === '5d' ? 'hour' : 
                   period === '30d' ? 'day' : 'day';
    
    // Recreate all charts with new data
    recreateAllCharts(labels, priceData, techData, period, timeUnit);
}

function showNoDataMessage() {
    const chartContainers = document.querySelectorAll('canvas');
    chartContainers.forEach(canvas => {
        const container = canvas.parentElement;
        container.innerHTML = `
            <div class="flex items-center justify-center h-full bg-gray-50 rounded-lg border border-gray-200">
                <div class="text-center">
                    <i class="fas fa-chart-area text-gray-400 text-4xl mb-4"></i>
                    <h4 class="text-lg font-semibold text-gray-700 mb-2">No Chart Data Available</h4>
                    <p class="text-gray-500">Chart data is not available for this time period.</p>
                </div>
            </div>
        `;
    });
}

// Initialize with 1Y data by default
document.addEventListener('DOMContentLoaded', function() {
    // Set initial period
    window.currentPeriod = '1y';
    
    // Set 1Y button as active initially
    const yearBtn = document.querySelector(`[onclick="loadPeriodData('1y')"]`);
    if (yearBtn) {
        yearBtn.classList.add('bg-blue-500', 'text-white');
        yearBtn.classList.remove('bg-gray-200', 'text-gray-700');
    }
});

function showLoadingState() {
    const canvasIds = ['price-chart', 'sma-chart', 'macd-chart', 'rsi-chart', 'bbands-chart', 'obv-chart'];
    canvasIds.forEach(id => {
        const canvas = document.getElementById(id);
        if (canvas) {
            const parent = canvas.parentElement;
            // Create loading overlay instead of replacing the canvas
            const overlay = document.createElement('div');
            overlay.className = 'loading-overlay';
            overlay.style.cssText = `
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(249, 250, 251, 0.95);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10;
            `;
            overlay.innerHTML = `
                <div class="text-center">
                    <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500 mx-auto mb-4"></div>
                    <h4 class="text-lg font-semibold text-gray-700 mb-2">Loading Chart Data</h4>
                    <p class="text-gray-500">Fetching data with optimal granularity...</p>
                </div>
            `;
            
            // Make parent relative if not already
            if (getComputedStyle(parent).position === 'static') {
                parent.style.position = 'relative';
            }
            
            parent.appendChild(overlay);
        }
    });
}

function hideLoadingState() {
    // Remove all loading overlays
    document.querySelectorAll('.loading-overlay').forEach(overlay => {
        overlay.remove();
    });
}

function showErrorState(errorMessage) {
    const canvasIds = ['price-chart', 'sma-chart', 'macd-chart', 'rsi-chart', 'bbands-chart', 'obv-chart'];
    canvasIds.forEach(id => {
        const canvas = document.getElementById(id);
        if (canvas) {
            const parent = canvas.parentElement;
            // Remove any existing overlays
            parent.querySelectorAll('.loading-overlay, .error-overlay').forEach(el => el.remove());
            
            // Create error overlay
            const overlay = document.createElement('div');
            overlay.className = 'error-overlay';
            overlay.style.cssText = `
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(254, 242, 242, 0.95);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10;
            `;
            overlay.innerHTML = `
                <div class="text-center">
                    <i class="fas fa-exclamation-triangle text-red-400 text-4xl mb-4"></i>
                    <h4 class="text-lg font-semibold text-red-700 mb-2">Error Loading Data</h4>
                    <p class="text-red-500 text-sm">${errorMessage}</p>
                    <button class="mt-3 px-4 py-2 bg-red-500 text-white rounded-md hover:bg-red-600 text-sm" 
                            onclick="location.reload()">
                        <i class="fas fa-redo mr-1"></i>Retry
                    </button>
                </div>
            `;
            
            // Make parent relative if not already
            if (getComputedStyle(parent).position === 'static') {
                parent.style.position = 'relative';
            }
            
            parent.appendChild(overlay);
        }
    });
}

function updateCurrentPrice(currentPrice) {
    // Update the current price display in the metrics section
    const priceElements = document.querySelectorAll('[data-price-display]');
    priceElements.forEach(element => {
        element.textContent = `$${currentPrice.toFixed(2)}`;
    });
}

// ...existing code...
</script>
{% endblock %}